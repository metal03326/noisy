self.onmessage=function(t){let e,n,{buffer:g,extension:l}=t.data,a=new DataView(g),r={},i=function(t,e){if(a.getUint8(e)===t.charCodeAt(0)){let n=!0;for(let g=1;g<t.length;g++)if(a.getUint8(e+g)!==t.charCodeAt(g)){n=!1;break}return n}return!1};switch(l){case"mp3":if(73===a.getInt8(0)&&68===a.getInt8(1)&&51===a.getInt8(2)){let t=a.getInt8(3);e={TPE1:"artist",TIT2:"title",TALB:"album",TYER:"date"};let n=Object.keys(e).length,g=4;const l=(4===t?8:128)|(4===t?4:64);for(;g<a.getInt32(6)&&n;){let t=!1;Object.keys(e).forEach(o=>{if(i(o,g)){t=!0,g+=4;let i=a.getUint32(g);const s=a.getInt8(g+5);if(g+=6,s&l)return g+=i,delete e[o],void(n=Object.keys(e).length);let f="",I=a.getUint8(g++);if(1===I||2===I){let t=0;(a.getUint8(g)<a.getUint8(g+1)||2===I)&&(t=1),i-=1+2*Math.abs(I-2),1===I&&(g+=2);let e=g+i;for(;g<e;g+=2){let e=a.getUint8(g+t),n=a.getUint8(g+1+-1*t);e&&(f+=`%${e.toString(16).padStart(2,"0")}`),n&&(f+=`%${n.toString(16).padStart(2,"0")}`)}}else{let t=g+(i-=1);for(;g<t;g++)f+=`%${a.getUint8(g).toString(16).padStart(2,"0")}`}r[e[o]]=decodeURIComponent(f),g--,delete e[o],n=Object.keys(e).length}}),t||g++}}break;case"opus":case"ogg":for(e=["artist","title","album","date"],n=0;n<1e3;){let t=a.getInt8(n);if(3===t&&118===a.getInt8(n+1)&&111===a.getInt8(n+2)&&114===a.getInt8(n+3)&&98===a.getInt8(n+4)&&105===a.getInt8(n+5)&&115===a.getInt8(n+6)||79===t&&112===a.getInt8(n+1)&&117===a.getInt8(n+2)&&115===a.getInt8(n+3)&&84===a.getInt8(n+4)&&97===a.getInt8(n+5)&&103===a.getInt8(n+6)&&115===a.getInt8(n+7)){n+=3===t?7:8;break}n++}if(n<999){n+=4+a.getInt32(n,!0);let t=a.getInt32(n,!0),g=0;for(n+=4;g<t&&e.length;){g++;let t=a.getInt32(n,!0);n+=4;let l=!1;for(let g=0;g<e.length;g++){let o=e[g];if(i(o,n)||i(o.toUpperCase(),n)){l=!0;let g=(n+=o.length+1)+(t-=o.length+1),i="";for(;n<g;n++)i+=`%${a.getUint8(n).toString(16).padStart(2,"0")}`;r[o]=decodeURIComponent(i),e.splice(e.indexOf(o),1);break}}l||(n+=t)}}break;case"m4a":e={"©art":"artist","©nam":"title","©alb":"album","©day":"date"};let t=Object.keys(e).length;n=0;let g=a.byteLength;for(;n<g&&t;){let g=!1;for(let l in e)if(e.hasOwnProperty(l)&&i(l,n)||i(l.toUpperCase(),n)){g=!0,n+=4;let i=a.getUint32(n)-15,o="",s=(n+=16)+i;for(;n<s;n++){let t=a.getUint8(n);t&&(o+=`%${t.toString(16).padStart(2,"0")}`)}r[e[l]]=decodeURIComponent(o),delete e[l],t=Object.keys(e).length}g||n++}}self.postMessage(r),close()};