"use strict";let n={audio:document.createElement("audio"),battery:null,cancelAction:!1,console:document.getElementById("console-content"),dropbox:dropbox,formats:[],googledrive:googledrive,langs:{},lastfm:lastfm,lastSearchTerm:"",local:{files:{},urlManager:urlManager,getFolderContents(){n.window("local-window"),document.getElementById("loading-folder-contents").classList.add("visibility-hidden")},isAuthenticated:!0,play(e){let t=this.urlManager.get(e.dataset.url);t||(t=URL.createObjectURL(n.local.files[e.parentNode.id][parseInt(e.dataset.url,10)]),this.urlManager.add(e.dataset.url,t)),n.lastfm.scrobble(),n.log("playbackWait",e.dataset.placeholder),n.setTitle(e),n.setFooter(e);let l=e.parentNode.querySelectorAll(".playlist-item");n.audio.dataset.item=Array.prototype.indexOf.call(l,e),n.audio.dataset.playlist=e.parentNode.id,n.audio.src=t,n.audio.load()},preload(){}},movingItem:null,movingItemHeight:-1,movingShouldSave:!1,movingStart:-1,powerSaveMode:!1,pref:pref,preloaded:!1,queue:[],reader:null,saveTimeout:null,shouldRefreshPlaylist:!1,shouldRefreshStatusBar:!1,shouldRefreshWindowTitle:!1,themes:{},_deselectItems(){let e=document.querySelectorAll(`#${n.activePlaylistId} .selected,.window .selected`);for(let t=0;t<e.length;t++){let n=e[t];n.classList.remove("selected"),n.classList.remove("confirmation")}},_prepareShortcutRow(e,t,n,l,a){e.dataset.keys=t,e.dataset.action=n,e.classList.add("va"),e.innerHTML=`<td>${l}</td><td class="${n}">${a}</td><td><button onclick="n.onDeleteKeyboardShortcut(this)">&times;</button></td>`},_selectItems(e,t,n,l){let a=document.getElementById("selection-start");if(e.shiftKey){if(a){let e=document.getElementById(t).querySelectorAll(n),o=Array.prototype.indexOf.call(e,a),d=Array.prototype.indexOf.call(e,this),s=document.getElementById(t).querySelectorAll(".selected");for(let e=0;e<s.length;e++)s[e].classList.remove("selected");if(!~o||!~d){let t=document.getElementById("find-window-results");t&&(e=t.querySelectorAll(n),o=Array.prototype.indexOf.call(e,a),d=Array.prototype.indexOf.call(e,this))}if(~o&&~d){let t=Math.min(o,d),n=Math.max(o,d);for(let a=t;a<=n;a++){e[a].classList.add(l)}e[o<=d?t:n].classList.add(l)}else this.classList.add(l),this.id="selection-start"}}else a&&a.removeAttribute("id"),this.id="selection-start",e.ctrlKey?this.classList.toggle(l):this.classList.add(l)},literalize(string){return eval("`"+string+"`")},_translate(){n.initWhatsNew(),document.documentElement.lang=n.pref.lang;let e=n.lang.splash;Object.keys(e).forEach(t=>{(document.getElementById(t)||{}).innerHTML=e[t]});let t=n.lang.menu;Object.keys(t).forEach(e=>{document.getElementById(e).innerHTML=t[e]});let l=n.lang.window;Object.keys(l).forEach(e=>{document.getElementById(e).innerHTML=n.literalize(l[e])});let a=n.lang.placeholders;Object.keys(a).forEach(e=>{document.getElementById(e).placeholder=a[e]});let o=n.lang.preferences,d="preferences-tabs";Object.keys(o).forEach(e=>{document.getElementById(d).querySelector(`button[data-preference="${e}"]`).innerHTML=o[e]});let s=n.lang.actions;d="actions",Object.keys(s).forEach(e=>{document.getElementById(d).querySelector(`option[value="${e}"]`).innerHTML=s[e];let t=document.getElementById("keyboard-shortcuts").querySelectorAll("."+e);for(let l=0;l<t.length;l++)t[l].innerHTML=n.lang.actions[e]});let r=n.lang.themes;d="preference-theme",Object.keys(r).forEach(e=>{document.getElementById(d).querySelector(`option[value="${e}"]`).innerHTML=r[e]});let i=n.lang.buttons;Object.keys(i).forEach(e=>{let t=document.querySelectorAll(`.${e}`);for(let n=0;n<t.length;n++)t[n].innerHTML=i[e]});let c=n.lang.validation;Object.keys(c).forEach(e=>{let t=document.querySelectorAll(`.${e}`);for(let n=0;n<t.length;n++)t[n].innerHTML=c[e]});let u=n.lang.console;Object.keys(u).forEach(e=>{let t=document.querySelectorAll(`.${e}`);for(let n=0;n<t.length;n++)t[n].innerHTML=u[e]});let m=n.lang.footer;Object.keys(m).forEach(e=>{(document.getElementById(e)||{}).innerHTML=m[e]});let y=n.lang.help;Object.keys(y).forEach(e=>{document.getElementById(e).title=y[e]});let p=n.lang.faq;document.getElementById("faq-content").innerHTML=Object.keys(p).map(e=>`<details><summary>${e}</summary><p>${p[e]}</p></details>`).join("");let g=document.getElementById("add-window-cloud-chooser").querySelectorAll('[data-cloud]:not([data-cloud*="local"])');for(let e=0;e<g.length;e++)g[e].title=n.lang.other["not-connected"];n.setTitle(null,!0),n.refreshWindowTitle()},get activeItem(){let e=document.getElementById("playlists").querySelector('div[data-icon="c"]')||document.getElementById("playlists").querySelector('div[data-icon="x"]')||document.getElementById("playlists").querySelector('div[data-icon="w"]');return e&&(e=e.parentNode.parentNode),e},get activePlaylistId(){let e=document.getElementById("playlists-tabs").querySelector(".active");return e?e.dataset.for:null},get lang(){return n.langs[n.pref.lang]},addFile(e,t){n.fillPlaylist(t,[{url:e.dataset.path,cloud:e.dataset.cloud,placeholder:e.dataset.name}])},addFileFolder(){let e=document.getElementById("add-window-files").querySelectorAll(".active"),t=n.activePlaylistId;n.cancelAction=!1,document.getElementById("cancel-action").hidden=!1,t||(n.newPlaylist(),t=n.activePlaylistId),asyncLoop(e.length-1,l=>{if(n.cancelAction)n.cancelAction=!1,l.break();else{let a=e[l.index];if("true"===a.dataset.folder){let e={added:0};n.addFolder(a.dataset.path,a.dataset.cloud,e,t).then(t=>{n.setFooter(`<span id="footer-finished">${n.lang.footer["footer-finished"]} ${e.added}</span>`),n.savePlaylist(document.getElementById(n.activePlaylistId)),l.next()})}else n.addFile(a,t),l.next()}}).then(e=>{n.savePlaylist(document.getElementById(n.activePlaylistId)),n.cancelAction=!1,document.getElementById("cancel-action").hidden=!0}),n.closeAll()},addFolder:(e,t,l,a)=>(n.setFooter(`<span id="footer-progress">${n.lang.footer["adding-files-from"]} ${e} ${n.lang.footer["added-items"]} ${l.added}</span>`),n[t].getFolderContents(e,!0).then(({files:e,folders:o})=>{let d=[];return l.added+=e.length,e.forEach(e=>{d.push({url:e.path,placeholder:e.name,cloud:e.cloud})}),n.fillPlaylist(a,d),o.length?new Promise(e=>asyncLoop(o.length-1,e=>{n.cancelAction?e.break():n.addFolder(o[e.index].path,t,l,a).then(e.next)}).then(e)):Promise.resolve()})),addItemToWindow(e){let t=document.createElement("section");return t.className="add-item",t.setAttribute("tabindex",0),Object.assign(t.dataset,e),t.innerHTML=`<span data-icon='${e.folder?"f":'"'}'></span>${e.name}`,t.addEventListener("mousedown",n.onAddItemDown),t.addEventListener("dblclick",n.onAddItemDblClick),document.getElementById("add-window-files").appendChild(t),t},addToQueue(e=n.currentlySelectedItem){function t(e){n.queue.push(e);let t=e.querySelector(".item-queue");t.innerHTML||(t.innerHTML=n.queue.length)}let l=document.getElementById(n.activePlaylistId).querySelectorAll(".selected");if(~Array.prototype.indexOf.call(l,e))for(let e=0;e<l.length;e++)t(l[e]);else t(e)},applyPowerSaveMode(){n.initAnimations(),n.initBlur(),n.changeCounterState(document.getElementById("preference-enable-counter").checked)},applyTheme(){let e=document.getElementById("preference-theme").value;return n.themes[e]?(document.getElementById("theme").innerHTML=n.themes[e],Promise.resolve()):fetch(`/js/themes/${e}.json?ver=${version}`).then(e=>e.json()).then(t=>{let l=Object.keys(t).map(e=>{let n=t[e];return`${e}{${Object.keys(n).map(e=>`${e}:${n[e]};`).join("")}}`}).join("");return document.getElementById("theme").innerHTML=l,n.themes[e]=l,Promise.resolve()})},applyWindowState(e){let t=document.querySelector(".window"),n={"add-window":{all(){let e=document.getElementById("add-window-buttons").querySelectorAll("button");e[0].disabled=!1,e[1].disabled=!1},file(){let e=document.getElementById("add-window-buttons").querySelectorAll("button");e[0].disabled=!1,e[1].disabled=!0},default(){let e=document.getElementById("add-window-buttons").querySelectorAll("button");e[0].disabled=!0,e[1].disabled=!0}},"save-playlist-window":{save(){let e=document.getElementById("save-playlist-window-buttons").children;e[0].disabled=!1,e[1].disabled=!1},semi(){let e=document.getElementById("save-playlist-window-buttons").children;document.getElementById("save-playlist-window-filename").value.trim()?(e[0].disabled=!1,e[1].disabled=!1):(e[0].disabled=!1,e[1].disabled=!0)},default(){let e=document.getElementById("save-playlist-window-buttons").children;e[0].disabled=!0,e[1].disabled=!0,document.getElementById("save-playlist-window-filename").value=""}},"load-playlist-window":{disabled(){document.getElementById("load-playlist-window-buttons").children[0].disabled=!0},file(){document.getElementById("load-playlist-window-buttons").children[0].disabled=!1},default(){document.getElementById("load-playlist-window-buttons").children[0].disabled=!0}},"save-preferences-window":{save(){let e=document.getElementById("save-preferences-window-buttons").children;e[0].disabled=!1,e[1].disabled=!1},semi(){let e=document.getElementById("save-preferences-window-buttons").children;document.getElementById("save-preferences-window-filename").value.trim()?(e[0].disabled=!1,e[1].disabled=!1):(e[0].disabled=!1,e[1].disabled=!0)},default(){let e=document.getElementById("save-preferences-window-buttons").children;e[0].disabled=!0,e[1].disabled=!0,document.getElementById("save-preferences-window-filename").value=""}},"load-preferences-window":{disabled(){document.getElementById("load-preferences-window-buttons").children[0].disabled=!0},file(){document.getElementById("load-preferences-window-buttons").children[0].disabled=!1},default(){document.getElementById("load-preferences-window-buttons").children[0].disabled=!0}}};t&&n[t.id]&&n[t.id][e]&&n[t.id][e]()},attachEvents(){let e=document.getElementById("drop-zone");function t(e){e.stopPropagation(),e.preventDefault(),e.target.className="dragover"===e.type?"hover":""}e.addEventListener("dragover",t,!1),e.addEventListener("dragleave",t,!1),e.addEventListener("drop",e=>{t(e),n.onFilesSupplied(e)},!1),document.getElementById("preference-enable-notifications").addEventListener("change",e=>n.notify(null,e.currentTarget.checked)),document.getElementById("playback-order").addEventListener("change",e=>{const t=e.currentTarget;n.audio.loop=!(2-t.selectedIndex),n.pref.playbackOrder=t.selectedIndex});let l=document.querySelectorAll(".playlists-tabs-li"),a=document.querySelectorAll("input"),o=document.querySelectorAll(".cloud-icon"),d=document.querySelectorAll("#preference-cursor-follows-playback,#preference-playback-follows-cursor");for(let e=0;e<l.length;e++)l[e].addEventListener("click",n.onTabClick),l[e].addEventListener("mousedown",n.onTabDown);for(let e=0;e<d.length;e++)d[e].addEventListener("change",n.onCursorCheckboxChange);for(let e=0;e<a.length;e++)a[e].addEventListener("keydown",n.stopBubbling);document.getElementById("keyboard-shortcut").addEventListener("keydown",e=>{const t=e.currentTarget,l=n.getKeys(e);t.value=l.keys.join(" + "),t.dataset.keys=l.keyProperty.join("+"),e.preventDefault()}),document.getElementById("shortcut-add").addEventListener("click",e=>{let t=document.getElementById("keyboard-shortcut");if(!t.value)return;let l=t.dataset.keys;if(document.getElementById("keyboard-shortcuts").querySelector(`tr[data-keys="${l}"]`))n.window("exists");else{let e=document.getElementById("actions"),a=document.createElement("tr"),o=document.getElementById("actions"),d="tr";for(;d!==e.tagName.toLowerCase();)e=e.parentNode;n._prepareShortcutRow(a,l,o.value,t.value,document.getElementById("actions").querySelector(`option[value="${o.value}"]`).innerHTML),e.parentNode.insertBefore(a,e),n.pref.key={action:o.value,key:t.getAttribute("data-keys")}}}),a=document.getElementById("preferences-container").querySelectorAll("input:not(#keyboard-shortcut)");let s=e=>n.pref.input=e.currentTarget;for(let e=0;e<a.length;e++)a[e].onchange=s;document.getElementById("find-item").addEventListener("keydown",n.find),document.getElementById("window-close").addEventListener("click",n.closeAll),document.getElementById("save-playlist-window-filename").addEventListener("input",n.onSaveNameInput),document.getElementById("save-preferences-window-filename").addEventListener("input",n.onSaveNameInput);let r=e=>{const t=e.currentTarget.dataset.cloud,l=n[t];l.isAuthenticated?(document.getElementById("loading-folder-contents").classList.remove("visibility-hidden"),n.selectService(t)):l.connect()};for(let e=0;e<o.length;e++)o[e].addEventListener("click",r);document.getElementById("playlists-wrapper").addEventListener("keydown",e=>{const t=e.keyCode,l=n.getKeys(e);if(!document.getElementById("keyboard-shortcuts").querySelector(`tr[data-keys="${l.keyProperty.join("+")}"]`))if(37===t||39===t){let l;const a=document.getElementById("playlists-tabs").querySelectorAll("div[data-for]");let o=document.querySelector(`div[data-for="${n.activePlaylistId}"]`);const d=Array.prototype.indexOf.call(a,o);o?(l=a[d+(37===t?-1:1)])||(l=a[37===t?a.length-1:0]):l=a[0],l&&(n.changePlaylist(l),document.getElementById("playlists-wrapper").focus()),e.preventDefault()}else if(38===t||40===t){let l=n.currentlySelectedItem[`${38===t?"previous":"next"}ElementSibling`];l||(l=document.getElementById(n.activePlaylistId)[`${38===t?"last":"first"}ElementChild`]),n._deselectItems(),n._selectItems.call(l,{},n.activePlaylistId,".playlist-item","selected"),scrollIntoViewIfOutOfView(l),e.preventDefault()}}),document.getElementById("show-on-startup-checkbox").addEventListener("change",e=>n.pref.showWhatsNew=e.currentTarget.checked),document.getElementById("preference-enable-animations").addEventListener("change",n.initAnimations),document.getElementById("preference-enable-scrobbling").addEventListener("change",e=>n.changeScrobblingState(e.currentTarget.checked)),document.getElementById("preference-enable-powersaver").addEventListener("change",e=>n.changePowerSaverState(e.currentTarget.checked)),document.getElementById("preference-enable-counter").addEventListener("change",e=>n.changeCounterState(e.currentTarget.checked))},stopRenames(){const e=document.querySelector('[contenteditable="true"]');e.removeAttribute("contenteditable"),e.removeEventListener("keydown",n.onRenameKeyDown)},changeCounterState(e){const t=document.getElementById("footer-counter");t.innerHTML="",t.hidden=!e||n.powerSaveMode},changeLanguage(e){n.pref.lang=e,n.translate()},changePlaylist(e){let t=document.getElementById("playlists-tabs").querySelector(".playlists-tabs-li.active");t&&(document.getElementById(t.dataset.for).hidden=!0,t.classList.remove("active")),e.classList.add("active"),document.getElementById(e.dataset.for).hidden=!1,n.saveActivePlaylistIdDelayed()},changePowerSaverState(e){document.getElementById("power-saver-state").disabled=!e,e&&n.battery?n.updateBatteryStatus():(n.powerSaveMode=!1,n.applyPowerSaveMode(),n.battery&&n.updateBatteryStatus())},changeScrobblingState(e){document.getElementById("lastfm-preferences").disabled=!e},changeStyle(e){n.applyTheme(),n.pref.theme=e},checkConnections(){const e=["dropbox","googledrive","lastfm"],t=(e,l)=>{const a=n[e];if(a.isAuthenticated)a.checkToken().then(e=>{let t=` <span class="as">${n.lang.console.as}</span>${a.display_name}`;n.log("connected",`${a.name}${t}`),document.getElementById(`connected-${a.codeName}`).innerHTML=t;const o=document.getElementById("add-window-cloud-chooser").querySelector(`[data-cloud="${a.codeName}"]`);o&&o.removeAttribute("title"),l()}).catch(e=>{document.getElementById(`connected-${a.codeName}`).innerHTML=n.lang.console.no,delete n[a.codeName].accessToken,n.pref.accessToken={cloud:a.codeName,accessToken:null};const t=document.getElementById("add-window-cloud-chooser").querySelector(`[data-cloud="${a.codeName}"]`);t&&(t.title=n.lang.other["not-connected"]),l()});else if(a.accessToken&&a.accessToken.constructor===Promise)a.accessToken.then(n=>t(e,l)).catch(n=>t(e,l));else{let t=document.getElementById("add-window-cloud-chooser").querySelector(`[data-cloud="${e}"]`);if(t)t.title=n.lang.other["not-connected"];else if("lastfm"===e){let e=document.getElementById("preference-enable-scrobbling");e.checked=!1,n.changeScrobblingState(!1),e.disabled=!0}document.getElementById(`connected-${e}`).innerHTML=n.lang.console.no,l()}},{hash:l,search:a}=location;let o=[];return l&&"#"!==l?o=l.split("#").pop().split("&"):a&&"?"!==a&&(o=a.split("?").pop().split("&")),o.some(e=>{if(e.startsWith("access_token=")){let t=e.split("=").pop();return n[n.pref.tokenCloud].accessToken=t,n.pref.accessToken={cloud:n.pref.tokenCloud,accessToken:t},!0}if(e.startsWith("token=")){const t=e.split("=").pop(),l=n[n.pref.tokenCloud].getAccessToken(t).then(e=>{n[n.pref.tokenCloud].userName=e.session.name,n[n.pref.tokenCloud].accessToken=e.session.key,n.pref.userName={cloud:n.pref.tokenCloud,userName:e.session.name},n.pref.accessToken={cloud:n.pref.tokenCloud,accessToken:e.session.key}}).catch(e=>n.error("error-getting-access-token",n[n.pref.tokenCloud].name));return n[n.pref.tokenCloud].accessToken=l,n.pref.accessToken={cloud:n.pref.tokenCloud,accessToken:l},n.changeScrobblingState(!0),!0}return!1}),history.replaceState({},"","/"),new Promise(n=>Promise.all(e.map(e=>new Promise(n=>t(e,n)))).then(n))},checkQuota(){let e=0,t=localStorage.getItem("preferences"),l=localStorage.getItem("playlists");t&&(e+=t.length),l&&(e+=l.length),52e5<e?n.error("quota-limit-reached"):4194304<=e?n.warn("quota-limit-nearing",`${(e/1024/1024).toFixed(2)} MB`):n.log("quota-used",`${(e/1024/1024).toFixed(2)} MB`)},clearConsole(){n.console.innerHTML=""},clearWindow(){let e=document.querySelectorAll("#keyboard-shortcut,#save-playlist-window-filename,#save-preferences-window-filename"),t=document.querySelector(".window").dataset,n=document.querySelectorAll("#connect-to,#add-files-service-choose,#actions");for(let t=0;t<e.length;t++)e[t].value="";Object.keys(t).forEach(e=>{delete t[e]});for(let e=0;e<n.length;e++)n[e].selectedIndex=0},closeAll(){n.closeWindow()},closePreferences(){n.shouldRefreshPlaylist&&n.refreshPlaylists(),n.shouldRefreshStatusBar&&n.refreshStatusbar(),n.shouldRefreshWindowTitle&&n.refreshWindowTitle();let e=document.getElementById("preferences-window-buttons").querySelectorAll(".confirmation");e.length&&e[0].classList.remove("confirmation")},closeWindow(){let e=document.querySelector(".window"),t=e.id;t&&(n.applyWindowState("default"),"preferences-window"===t&&n.closePreferences(),setTimeout(t=>e.removeAttribute("id"),300),e.className="window",n.clearWindow()),e.parentNode.classList.remove("window-opened")},connect(){n.window("connect-window")},connectTo(){n[document.getElementById("connect-to").value].connect()},createPlaylist(e,t,l){e=e.trim();const a=document.createElement("div");a.dataset.for=t,a.dataset.name=e,a.className="playlists-tabs-li flex",a.tabIndex=0,a.innerHTML=`<div class="playlist-name">${e}</div> <div class="playlist-edit"><span data-icon="!"></span></div> <div class="playlist-remove">&times;</div>`,a.querySelector(".playlist-name").addEventListener("dblclick",n.renamePlaylist),a.querySelector(".playlist-edit").addEventListener("click",n.renamePlaylist),a.querySelector(".playlist-remove").addEventListener("click",n.deletePlaylist),document.getElementById("playlists-tabs").insertBefore(a,document.getElementById("add-playlist")),a.addEventListener("click",n.onTabClick),a.addEventListener("mousedown",n.onTabDown);const o=document.createElement("article");return o.hidden=!0,o.id=t,o.dataset.name=e,o.className="playlist scroll-y",o.setAttribute("onscroll","n.saveActivePlaylistIdDelayed()"),document.getElementById("playlists").appendChild(o),l&&n.savePlaylists(),n.oneTabCheck(),a},get currentlySelectedItem(){return n.currentlySelectedItems[0]||document.getElementById(n.activePlaylistId).children[0]},get currentlySelectedItems(){return document.getElementById(n.activePlaylistId).querySelectorAll(".selected")},deleteItems(e){let t=e?[e]:n.currentlySelectedItems,l=t.length;for(let e=0;e<l;e++){t[e].remove()}l&&n.savePlaylist(document.getElementById(n.activePlaylistId))},deletePlaylist(e){const t=e.currentTarget.closest("[data-for]"),l=t.previousElementSibling||t.nextElementSibling;"add-playlist"===l.id?n.pref.activePlaylistId=null:n.changePlaylist(l),t.remove(),document.getElementById(t.dataset.for).remove(),n.savePlaylists(),n.oneTabCheck()},detectFormats(){if(!n.formats.length){["audio/mpeg;",'audio/ogg; codecs="vorbis"','audio/ogg; codecs="opus"','audio/wav; codecs="1"','audio/mp4; codecs="mp4a.40.2"'].forEach(e=>{n.audio.canPlayType(e).replace(/no/,"")&&n.formats.push(e.split(";")[0])})}},emptyAddWindow(){document.getElementById("add-window-files").innerHTML=""},emptyFindWindow(){n.initSearch(document.getElementById("find-item").value=n.lastSearchTerm="")},error(e,t=""){n.console.innerHTML+=`<div class="nb-error"><span class="${e}">${n.lang.console[e]}</span>${t}</div>`,document.getElementById("color-bulb").classList.add("nb-error")},fillPlaylist(e,t,l){let a=document.createDocumentFragment();t.forEach(e=>{let t=document.createElement("section");t.setAttribute("tabindex",0),e.cloud=e.cloud||"dropbox",Object.assign(t.dataset,e);let l=e.mimetype;l&&!n.formats.includes(l)&&t.classList.add("can-not-play"),t.classList.add("playlist-item"),t.classList.add("flex"),t.innerHTML='<div class="flex playback-options"><div class="flex-item-full"><div class="item-queue"></div><div class="item-add-to-queue" data-icon="Q"></div><div class="item-remove-from-queue" data-icon="P"></div></div><div class="playback-status"></div></div><div class="item-title flex-ellipsis"></div>',n.renderItem(t),t.addEventListener("dblclick",n.onRowDblClick),t.addEventListener("mousedown",n.onRowDown),a.appendChild(t)}),document.getElementById(e).appendChild(a),l&&n.savePlaylist(document.getElementById(e))},find(e){const t=e.keyCode;if(13===t){const t=e.currentTarget.value.toLowerCase().trim();if(n.lastSearchTerm===t)n.play();else{n.initSearch(n.lastSearchTerm=t);const e=document.getElementById("find-window-results").querySelector(".playlist-item");e&&n.onRowDown({target:e,currentTarget:e})}}else if(38===t||40===t){let e=document.getElementById("find-window-results").querySelectorAll(".playlist-item");if(e.length){const l=document.getElementById("find-window-results").querySelector(".selected"),a=Array.prototype.indexOf.call(e,l);let o;o=38===t?0>a-1?e[e.length-1]:e[a-1]:e.length<=a+1?e[0]:e[a+1],n.onRowDown({target:o,currentTarget:o})}}else 27===t&&n.closeAll()},formatString(e,t){let n={artist:/%artist%/g.exec(e),album:/%album%/g.exec(e),title:/%title%/g.exec(e),date:/%date%/g.exec(e)},l=0;return Object.keys(n).forEach(a=>{let o=n[a],d=o?new RegExp(o[0],"g"):"";o&&t.dataset[a]?e=e.replace(d,t.dataset[a]):o?(e=e.replace(d,""),l++):l++}),4===l&&(e=t.dataset.placeholder),e},getAllItems:(e=n.activePlaylistId)=>document.getElementById(n.activePlaylistId).querySelectorAll(".playlist-item"),getCloud:e=>e.dataset.cloud,getItem:(e,t)=>t?n.getAllItems(e).item(t):n.currentlySelectedItem,getKeys(e){let t=[],n=[];const l=e.keyCode,a={16:e.shiftKey,17:e.ctrlKey,18:e.altKey,91:e.metaKey},o=Object.keys(a);return o.forEach(e=>a[e]&&n.push(keyCodes[e])&&t.push(e)),!o.includes(l)&&n.push(keyCodes[l])&&t.push(l),{keys:n,keyProperty:t}},getURLFromItem:(e=n.currentlySelectedItem)=>e?e.dataset.url:null,init:()=>(n.pref.process(),location.host.includes("appspot")&&location.replace("https://www.noisyplayer.com"),Promise.all([n.translate(),n.applyTheme()]).then(n.checkConnections).then(e=>{n.initBatteryWatcher().then(e=>n.applyPowerSaveMode()),n.initAudio(),n.updateScrobbleCounter(),n.changeScrobblingState(n.pref.settings.checkboxes["preference-enable-scrobbling"]);if(n.loadAndRenderPlaylists(),n.checkQuota(),n.pref.activePlaylistId){let e=document.getElementById(n.pref.activePlaylistId);if(e){let t=n.pref.scrollTop;setTimeout(n=>e.scrollTop=t),n.changePlaylist(document.querySelector(`div[data-for="${n.pref.activePlaylistId}"]`))}else n.warn("missing-element",n.pref.activePlaylistId)}n.attachEvents();let t=document.querySelectorAll("div[data-menulistener]"),l=document.querySelectorAll(".preferences-item"),a=function(e){e.stopPropagation(),n[this.dataset.menulistener].call(this)},o=function(){if(this.classList.contains("active"))return;let e=document.getElementById("preferences-container").children,t=e.length;document.getElementById("preferences-tabs").querySelector(".active").classList.remove("active"),this.classList.add("active");for(let n=0;n<t;n++)e[n].hidden=!0;document.getElementById(`preference-${this.dataset.preference}`).hidden=!1};for(let e=0;e<t.length;e++)t[e].addEventListener("click",a);for(let e=0;e<l.length;e++)l[e].addEventListener("click",o);document.getElementById("progress").addEventListener("mousedown",n.onBarDown),document.getElementById("volume").addEventListener("mousedown",n.onBarDown),document.body.addEventListener("click",n.closeAll),document.querySelector(".window").addEventListener("click",n.stopBubbling),document.body.addEventListener("keydown",e=>{let t=n.getKeys(e),l=document.getElementById("keyboard-shortcuts").querySelector(`tr[data-keys="${t.keyProperty.join("+")}"]`);l&&(n[l.dataset.action](),e.preventDefault()),27===e.keyCode&&(n.closeAll(),e.preventDefault())}),document.getElementById("footer").addEventListener("dblclick",e=>{let t,l,a=n.activeItem;a&&((l=(t=a.parentNode).id)!==n.activePlaylistId&&n.changePlaylist(document.querySelector(`div[data-for="${l}"]`)),scrollIntoViewIfOutOfView(a))}),document.getElementById("playlists-tabs").addEventListener("dblclick",e=>e.currentTarget===e.target&&n.newPlaylist()),n.pref.showWhatsNew&&n.showWhatsNew();let d=Date.now();return n.log("startup",`${d-timerStart}<span class='ms'>${n.lang.console.ms}</span>`),Promise.resolve()})),initAnimations(){let e=[];if(!n.powerSaveMode&&n.pref.settings.checkboxes["preference-enable-animations"]){const t=` ${".5s"} ${"linear"}`,n=`${t},`,l={"#the-menu,#splash":["opacity","visibility"],".preferences-item,.add-item":["background","color"],"#drop-zone":"border",".window,.cloud-icon,#battery-level-menu-handle:hover,.menu-ul-li:hover,[data-menulistener]:hover":"opacity","#color-bulb":"color","#header,#playlists-wrapper,#footer,#add-window-files":"filter"};e=[spinKeyframes],Object.keys(l).forEach(a=>{let o=l[a];Array.isArray(o)||(o=[o]),e.push(`${a}{transition:${o.join(n)}${t}}`)})}document.getElementById("animations").innerHTML=e.join("")},initBlur(){let e=[];n.powerSaveMode||(e=[".window-opened~*{filter:blur(5px)}","#loading-folder-contents:not(.visibility-hidden)+#add-window-files:{filter:blur(5px)}"]),document.getElementById("blur").innerHTML=e.join("")},initAudio(){n.audio.preload="auto",n.audio.id="audio",document.body.appendChild(n.audio),n.audio.addEventListener("canplay",function(){n.audio.paused&&this.play()}),n.audio.addEventListener("play",function(){let e,t=parseInt(this.dataset.item,10),l=this.dataset.playlist,a=document.getElementById("playlists").querySelector(".bold");a&&a.classList.remove("bold"),n.preloaded=!1,"number"!=typeof t||isNaN(t)||(e=document.getElementById(l).querySelectorAll(".playlist-item")[t],n.setItemState("x",!1,e),e===n.queue[0]&&n.removeFromQueue(e),e.classList.add("bold"),n.setTitle(e),n.setFooter(e),n.notify(e),n.lastfm.isAuthenticated&&n.lastfm.updateNowPlaying(e),n.audio.dataset.start=Math.floor(Date.now()/1e3),n.log("playbackStart",e.dataset.placeholder)),n.updateMeters()}),n.audio.addEventListener("pause",e=>n.setItemState("c",!1,document.getElementById(n.audio.dataset.playlist).querySelectorAll(".playlist-item")[parseInt(n.audio.dataset.item,10)])),n.audio.addEventListener("ended",function(){let e=document.getElementById(this.dataset.playlist).querySelectorAll(".playlist-item")[parseInt(this.dataset.item,10)],t=n.next("next",!0);e.classList.remove("bold"),n.setItemState(null,!1,e),n.lastfm.isAuthenticated&&n.lastfm.scrobble(),t&&n[t.dataset.cloud].play(t)}),n.detectFormats()},initBatteryWatcher:()=>navigator.getBattery?navigator.getBattery().then(e=>{n.battery=e,n.battery.addEventListener("chargingchange",n.updateBatteryStatus),n.battery.addEventListener("levelchange",n.updateBatteryStatus),setTimeout(n.updateBatteryStatus,1e3)}):Promise.reject(new Error("No Battery API support")),initSearch(e){const t=document.getElementById("find-window-results");if(t.innerHTML="",e){const l=document.getElementById("playlists").querySelectorAll("article:not([hidden]) section[data-url]"),a=e.split(" ");e:for(let e=0;e<l.length;e++){const o=l[e],d=o.dataset.url.toLowerCase(),s=o.querySelector(".item-title").innerHTML.toLowerCase();for(let e=0;e<a.length;e++){const t=a[e];if(!d.includes(t)&&!s.includes(t))continue e}const r=o.cloneNode(!0);r.querySelector(".playback-options").remove(),r.querySelector(".item-duration").remove(),t.appendChild(r),r.addEventListener("mousedown",n.onRowDown),r.addEventListener("dblclick",n.onRowDblClick)}}},initWhatsNew(){document.getElementById("whats-new-content").innerHTML=n.lang.whatsnew.map(e=>`<div class="flex">\n\t\t\t\t<i data-icon="o"></i>\n\t\t\t\t<div>${e}</div>\n\t\t\t</div>`).join("")},loadAndRenderPlaylists(){let e=n.loadPlaylists();e&&e.forEach(e=>{e.id&&e.name&&e.items?(n.createPlaylist(e.name,e.id,!1),n.fillPlaylist(e.id,e.items,!1)):n.error("error-loading-playlist",e.name||e.id)})},loadPlaylist(e){if(!(e&&e.id&&e.name&&e.items))return void n.error("error-loading-playlist",e&&(e.id||e.name)||"");let t=document.querySelector(`div[data-for="${e.id}"]`);t&&n.deletePlaylist({currentTarget:t}),n.createPlaylist(e.name,e.id),n.fillPlaylist(e.id,e.items,!0)},loadPlaylists(){let e=localStorage.getItem("playlists");return e?JSON.parse(e):null},loadPlaylistFromCloud(){let e=document.getElementById("add-window-files"),t=e.querySelectorAll(".active"),l=e.dataset.cloud;if(l)for(let e=0;e<t.length;e++)n[l].loadNoisyFile(t[e]).then(e=>{if("playlist"!==e.type)throw new Error("Not a valid playlist");{n.loadPlaylist(e);let t=document.querySelector(`li[data-for="${e.id}"]`);t&&n.changePlaylist(t)}});n.closeAll()},loadPreferencesFromCloud(){let e=document.getElementById("add-window-files"),t=e.querySelectorAll(".active"),l=e.dataset.cloud;t.length&&l&&n[l].loadNoisyFile(t[0]).then(e=>{if("preferences"!==e.type)throw new Error("Not a valid preferences file");delete e.type,n.pref.import(e)})},log(e,t=""){n.console.innerHTML+=`<div><span class="${e}">${n.lang.console[e]}</span>${t}</div>`},makePlaylistItems(e){let t=document.getElementById(e).querySelectorAll('.playlist-item:not([data-cloud="local"])'),n=[];for(let e=0;e<t.length;e++)n.push(Object.assign({},t[e].dataset));return n},moveElement(e,t){t.insertAdjacentElement(e,n.movingItem),n.movingShouldSave=!0},newPlaylist(){let e=n.lang.other["new-playlist"],t=n.createPlaylist(e,`playlist-${Date.now()}`,!0);t&&n.renamePlaylist({currentTarget:t.querySelector(".playlist-name")})},next(e,t){if(n.waitingItem)return;let l=n.activeItem,a=null,o=n.currentlySelectedItem,d=document.getElementById("playback-order").selectedIndex;if(2!==d&&("string"!=typeof e&&(e="next"),t||(n.setTitle(null,!0),n.setFooter(null,!0)),l)){if(n.pref.playbackFollowsCursorEnabled&&o&&4!==d?a=o:"next"===e&&n.queue.length&&(a=n.queue[0]),a)t||n.setItemState();else switch(d){case 0:a=l[`${e}Sibling`];break;case 1:(a=l[`${e}Sibling`])||(a=n.getAllItems(),a="previous"===e?a.item(a.length-1):a.item(0));break;case 3:let t=n.getAllItems();a=t[Math.floor(Math.random()*t.length)]}if(t)return a;l&&n.setItemState(),a?(a.querySelector(".playback-status").dataset.icon="w",n.play(a)):n.audio.paused||n.stop()}},nextRandom(){let e=document.getElementById("playback-order"),t=e.selectedIndex;e.selectedIndex=3,n.next(),e.selectedIndex=t},notify(e=n.activeItem,t){if(!n.powerSaveMode)if(t&&"granted"!==Notification.permission)Notification.requestPermission(e=>{Notification.permission!==e&&(Notification.permission=e)});else if(void 0===t&&n.pref.notify)if(Notification&&"granted"===Notification.permission){let t=new Notification(n.lang.other["notification-title"],{icon:document.getElementById("notify-logo").href,body:n.formatString(document.getElementById("preference-notification-popup-format").value,e)});t.onshow=function(){setTimeout(t.close.bind(this),3e3)}}else"undefined"!=typeof Notification&&"denied"!==Notification.permission&&Notification.requestPermission(t=>{if(Notification.permission!==t&&(Notification.permission=t),"granted"===t){let t=new Notification(n.lang.other["notification-title"],{icon:document.getElementById("notify-logo").href,body:n.formatString(document.getElementById("preference-notification-popup-format").value,e)});t.onshow=function(){setTimeout(t.close.bind(this),3e3)}}})},onAddItemDown(e){if(!e.ctrlKey&&!e.shiftKey){let e=document.getElementById("add-window-files").querySelectorAll(".add-item");const t="active";for(let n=0;n<e.length;n++)e[n].classList.remove(t)}n._selectItems.call(this,e,"add-window-files",".add-item","active"),"false"===this.dataset.folder?n.applyWindowState("file"):n.applyWindowState("all")},onAddItemDblClick(){if("true"===this.dataset.folder)n.openFolder();else{switch(document.querySelector(".window").id){case"load-playlist-window":n.loadPlaylistFromCloud();break;case"load-preferences-window":n.loadPreferencesFromCloud();break;default:n.addFileFolder()}}},onBarDown(e){n.movingItem=e.currentTarget,document.body.addEventListener("mousemove",n.onBarMove),document.body.addEventListener("mouseup",n.onBarUp)},onBarMove(e){let t=n.movingItem,l=t.getBoundingClientRect(),a=e.pageX-l.left,o=t.offsetWidth,d=100*Math.min(Math.max(0,a),o)/o;"progress"!==t.id||n.audio.paused?"volume"===t.id&&(n.pref.volume=d/100):(n.audio.currentTime=n.audio.duration*d/100,n.setProgress(t,d))},onBarUp(e){n.onBarMove(e),n.movingItem=null,document.body.removeEventListener("mousemove",n.onBarMove),document.body.removeEventListener("mouseup",n.onBarUp)},onDeleteKeyboardShortcut(e){let t=e.closest("tr"),l=Array.prototype.indexOf.call(t.closest("tbody").children,t);t.remove(),n.pref.deleteKey=l},oneTabCheck(){document.getElementById("preference-hide-playlist-tabs").checked&&2===document.querySelectorAll(".playlists-tabs-li").length?document.body.classList.add("one-tab"):document.body.classList.remove("one-tab")},onLanguageChange(e){n.changeLanguage(e.value)},openFolder(){let e=document.getElementById("add-window-files").querySelector(".active");document.getElementById("loading-folder-contents").classList.remove("visibility-hidden"),n[e.dataset.cloud].getFolderContents(e.dataset.path)},onCursorCheckboxChange(){if(this.checked){let e=["preference-cursor-follows-playback","preference-playback-follows-cursor"];e.splice(e.indexOf(this.id),1),document.getElementById(e[0]).checked=!1}},onFilesSupplied(e){const t=Array.from(e.files||e.dataTransfer.files);let l=n.activePlaylistId;l||(n.newPlaylist(),l=n.activePlaylistId),n.local.files[l]=n.local.files[l]||[];const a=n.local.files[l].length;return n.fillPlaylist(l,t.map((e,t)=>(n.local.files[l].push(e),{cloud:"local",mimetype:e.type.replace("mp3","mpeg").replace("x-m4a","mp4"),placeholder:e.name,url:a+t})),!1),n.closeAll(),document.getElementById("selected-playback-files").value="",n.powerSaveMode||t.forEach((e,t)=>{const o=new FileReader,d=document.querySelector(`#${l} .playlist-item[data-url="${a+t}"]`);n.setItemState("w",!1,d,!1),o.addEventListener("load",t=>{n.readTags(t.target.result,e.name.split(".").pop()).then(e=>{n.setItemState(null,!1,d),n.updateItemTags(e,d)})},{once:!0}),o.readAsArrayBuffer(e)}),!1},onPowerSaverStateChange(e){n.pref.powerSaverState=e.value,n.updateBatteryStatus()},onRenameKeyDown(e){const t=e.keyCode;if(e.stopPropagation(),13===t)e.preventDefault(),n.playlistNameCheck();else if(27===t){e.preventDefault();const t=e.currentTarget;t.innerHTML=t.closest("[data-for]").dataset.name,n.stopRenames()}},onRowDblClick(){n.setItemState(),n.play()},onRowDown(e){let t=e.target,l=e.currentTarget;return l.classList.contains("confirmation")&&t.classList.contains("delete-icon")?n.deleteItems():t.classList.contains("delete-icon")?l.classList.add("confirmation"):t.classList.contains("item-add-to-queue")?n.addToQueue(l):t.classList.contains("item-remove-from-queue")?n.removeFromQueue(l):(requestAnimationFrame(t=>{if(e.ctrlKey||e.shiftKey||n._deselectItems(),n._selectItems.call(l,e,n.activePlaylistId,".playlist-item","selected"),document.getElementById("find-window-results").contains(l)){let e=document.querySelectorAll(".window .selected");const t="selected";let a=document.querySelectorAll(`#${n.activePlaylistId} .selected`);for(let e=0;e<a.length;e++)a[e].classList.remove(t);for(let l=0;l<e.length;l++)document.getElementById(n.activePlaylistId).querySelector(`section[data-url="${e[l].dataset.url}"]`).classList.add(t);let o=document.getElementById(n.activePlaylistId).querySelector(`section[data-url="${l.dataset.url}"]`);o.classList.add(t),scrollIntoViewIfOutOfView(o),scrollIntoViewIfOutOfView(l)}}),n.movingItem=e.currentTarget,n.movingItemHeight=l.offsetHeight,n.movingStart=e.clientY,document.body.addEventListener("mousemove",n.onRowMove),void document.body.addEventListener("mouseup",n.onRowUp))},onRowMove(e){let t=e.clientY,l=n.movingStart-t;if(Math.abs(l)>n.movingItemHeight){let e,a,o=n.getAllItems(),d=Array.prototype.indexOf.call(o,n.movingItem);0<l?(e=o[d-1],a="beforebegin"):(e=o[d+1],a="afterend"),e&&(n.moveElement(a,e),n.movingStart=t)}},onRowUp(){n.movingShouldSave&&n.savePlaylist(document.getElementById(n.activePlaylistId)),n.movingItem=null,n.movingItemHeight=n.movingStart=-1,n.movingShouldSave=!1,document.body.removeEventListener("mousemove",n.onRowMove),document.body.removeEventListener("mouseup",n.onRowUp)},onSaveNameInput(e){let t=e.currentTarget.value.trim();e.altKey||e.altGraphKey||e.ctrlKey||e.shiftKey||!t?t||n.applyWindowState("semi"):n.applyWindowState("save")},onStyleChange(e){n.changeStyle(e.value)},onTabClick(e){const t=e.currentTarget;e.stopPropagation(),"add-playlist"===t.id?n.newPlaylist():n.changePlaylist(t)},onTabDown(e){n.movingItem=e.currentTarget,n.movingStart=e.clientX,document.body.addEventListener("mousemove",n.onTabMove),document.body.addEventListener("mouseup",n.onTabUp)},onTabMove(e){let t,l,a,o=document.querySelectorAll(".playlists-tabs-li"),d=Array.prototype.indexOf.call(o,n.movingItem),s=e.clientX,r=n.movingStart-s;0<r?(a=o[d-1],l="beforebegin"):(a=o[d+1],l="afterend"),a&&"add-playlist"!==a.id&&(t=a.offsetWidth,Math.abs(r)>t&&(n.moveElement(l,a),n.movingStart=s))},onTabUp(){n.movingShouldSave&&n.savePlaylists(),n.movingItem=null,n.movingStart=-1,n.movingShouldSave=!1,document.body.removeEventListener("mousemove",n.onTabMove),document.body.removeEventListener("mouseup",n.onTabUp)},play(e={}){if(n.activeItem&&n.audio.paused)return n.playPause();if(!e.tagName&&!(e=n.currentlySelectedItem))return;n.pref.cursorFollowsPlaybackEnabled&&(n._deselectItems(),n._selectItems.call(e,{},n.activePlaylistId,".playlist-item","selected"));let t=n.getCloud(e);if(n.audio.parentNode||n.initAudio(),!n[t].isAuthenticated)return n[t].connect();n.log("playbackWait",e.dataset.placeholder),n.setTitle(e),n.setFooter(e),n[t].play(e)},playlistNameCheck(){const e=document.querySelector(`div[data-for="${n.activePlaylistId}"] .playlist-name`),t=e.innerHTML.trim();t&&(e.contentEditable?(document.querySelector(`#playlists-tabs [data-for="${n.activePlaylistId}"]`).dataset.name=t,n.savePlaylist(document.getElementById(n.activePlaylistId))):n.createPlaylist(t,n.activePlaylistId,!0),n.stopRenames())},playPause(){n.audio.paused&&n.activeItem?n.audio.play():n.activeItem&&n.audio.pause()},prev(){n.next("previous")},readTags:(e,t)=>new Promise(n=>{const l=new Worker("/js/tagReader.js?ver="+version);l.postMessage({buffer:e,extension:t}),l.onmessage=(e=>n(e.data))}),removeFromPlaylist(){let e=document.getElementById(n.activePlaylistId).querySelectorAll(".playlist-item.selected"),t=e.length,l=0;for(let n=0;n<t;n++){let t=e[n];t.classList.contains("confirmation")?l++:t.classList.add("confirmation")}t===l&&n.deleteItems()},removeFromQueue(e=n.currentlySelectedItem){let t=n.queue.indexOf(e);~t&&(n.queue.splice(t,1),e.querySelector(".item-queue").innerHTML="",n.updateQueueStates())},refreshPlaylists(){let e=document.getElementById("playlists").querySelectorAll(".playlist-item");for(let t=0;t<e.length;t++)n.renderItem(e[t]);n.shouldRefreshPlaylist=!1},refreshStatusbar(){let e=document.getElementById("playlists").querySelector('div[data-icon="x"]');e&&n.setFooter(e.parentNode.parentNode),n.shouldRefreshStatusBar=!1},refreshWindowTitle(){let e=document.getElementById("playlists").querySelector('div[data-icon="x"]');e&&n.setTitle(e.parentNode),n.shouldRefreshWindowTitle=!1},renamePlaylist(e){const t=e.currentTarget.closest("[data-for]"),l=t.querySelector(".playlist-name");l.setAttribute("contenteditable","true"),document.body.addEventListener("click",n.playlistNameCheck,{once:!0}),l.addEventListener("keydown",n.onRenameKeyDown),l.focus(),n.changePlaylist(t),document.execCommand("selectAll",!1,null)},renderItem(e){let t=e.querySelectorAll(".item-duration"),l=e.dataset.duration||"";t.length?t[0].innerHTML=l:e.innerHTML+=`<span class="item-duration">${l}</span><div class="delete-icon" tabindex="-1" data-icon="m"></div>`,e.querySelector(".item-title").innerHTML=n.formatString(document.getElementById("preference-playlist-format").value,e)},renderKeyboardShortcuts(){let e=document.getElementById("keyboard-shortcuts").querySelectorAll(".va");for(let t=0;t<e.length;t++){e[t].remove()}let t=document.getElementById("actions");for(;"tr"!==t.tagName.toLowerCase();)t=t.parentNode;let l=document.createDocumentFragment();n.pref.keys.forEach(e=>{let t=document.createElement("tr"),a=document.getElementById("actions").querySelector(`option[value="${e.action}"]`).innerHTML,o=e.key.split("+");o.forEach((e,t)=>{o[t]=keyCodes[o[t]]}),o=o.join(" + "),n._prepareShortcutRow(t,e.key,e.action,o,a),l.appendChild(t)}),t.parentNode.insertBefore(l,t)},resetAddWindow(){n.emptyAddWindow();const e=document.getElementById("add-window-files");document.getElementById("add-window-cloud-chooser").hidden=!1,delete e.dataset.path,delete e.dataset.cloud,delete e.dataset.filter,document.getElementById("loading-folder-contents").classList.add("visibility-hidden")},restoreToDefaults(){let e=document.querySelector("#preferences-window-buttons .confirmation");e&&e.classList.remove("confirmation"),localStorage.removeItem("preferences"),n.pref.settings=JSON.parse(JSON.stringify(n.pref.originalSettings)),n.pref.process(),n.changeScrobblingState(n.pref.settings.checkboxes["preference-enable-scrobbling"]),n.translate(),n.initAnimations(),n.initBlur(),n.checkConnections(),n.applyTheme(),n.checkQuota(),n.initWhatsNew()},saveActivePlaylist:(e,t)=>n.savePlaylist(document.getElementById(n.activePlaylistId),e,t),savePlaylist(e,t){let l=e.id,a={id:l,name:document.querySelector(`#playlists-tabs [data-for="${l}"]`).querySelector(".playlist-name").textContent,items:n.makePlaylistItems(l)};if(t)return a;let o=n.loadPlaylists(),d=!0;for(let e=0;e<o.length;e++)if(o[e].id===a.id){o[e]=a,d=!1;break}d&&o.push(a),localStorage.setItem("playlists",JSON.stringify(o))},savePlaylists(){localStorage.setItem("playlists",JSON.stringify(Array.from(document.getElementById("playlists").querySelectorAll("article.playlist")).map(e=>n.savePlaylist(e,!0))))},savePlaylistToCloud(){let e=document.getElementById("add-window-files"),t=document.getElementById("save-playlist-window-filename").value.trim(),{path:l,cloud:a}=e.dataset;t&&l&&a&&(n.setFooter(n.lang.footer["please-wait"]),n[a].saveNoisyFile(`${t}.plst.nsy`,l)),n.closeAll()},saveActivePlaylistIdDelayed(){clearTimeout(n.saveTimeout),n.saveTimeout=setTimeout(e=>n.pref.activePlaylistId=n.activePlaylistId,1e3)},savePreferencesToCloud(){let e=document.getElementById("add-window-files"),t=document.getElementById("save-preferences-window-filename").value.trim(),{path:l,cloud:a}=e.dataset;t&&l&&a&&(n.setFooter(n.lang.footer["please-wait"]),n[a].saveNoisyFile(`${t}.pref.nsy`,l)),n.closeAll()},selectService(e){document.getElementById("add-window-cloud-chooser").hidden=!0,document.querySelector(".window").className=`window ${e}`,n[e].getFolderContents("")},setFooter(e,t){let l=document.getElementById("footer-text");t?(l.innerHTML="",n.cancelAction=!0,document.getElementById("cancel-action").hidden=!0):"string"==typeof e?l.innerHTML=e:(e||(e=n.getItem(n.activePlaylistId)),l.innerHTML=n.formatString(document.getElementById("preference-status-bar-format").value,e))},setItemState(e,t,l,a=!0){if((l=l||document.querySelector(".preloaded")||n.activeItem||n.currentlySelectedItem).classList.remove("preloaded"),l=l.querySelector(".playback-status")){let o=a&&document.getElementById("playlists").querySelector(`.playback-status[data-icon="${e}"]`);o&&delete o.dataset.icon,delete l.dataset.icon,t&&"string"==typeof e?(l=n.currentlySelectedItem).querySelector(".playback-status").dataset.icon=e:"string"==typeof e&&(l.dataset.icon=e)}},setProgress(e,t){parseInt(e.children[0].style.width)!==t&&(document.getElementById("volume")!==e||n.audio.muted||(document.getElementById("trigger-mute").dataset.icon=Math.min(3,Math.round(n.audio.volume/.33)+1)),e.children[0].style.width=`${t}%`)},setTitle(e,t){t?document.title=n.lang.title:(e||(e=n.getItem(n.activePlaylistId)),document.title=n.formatString(document.getElementById("preference-window-title-format").value,e))},shareYouTubeLink(e){},showAbout(){n.window("about-window")},showPreferences(e){e&&e.stopPropagation(),n.window("preferences-window");let t=document.getElementById("color-bulb");t.classList.remove("nb-error"),t.classList.remove("nb-warn"),n.console.scrollTop=n.console.offsetHeight},showAddFileFolder(){n.window("add-window")},showLoadPlaylist(){n.window("load-playlist-window"),document.getElementById("add-window-files").dataset.filter="plst.nsy"},showLoadPreferences(){n.window("load-preferences-window"),document.getElementById("add-window-files").dataset.filter="pref.nsy"},showSavePlaylist(){n.window("save-playlist-window")},showSavePreferences(){n.window("save-preferences-window")},showSearch(e){e&&e.stopPropagation(),n.window("find-window"),setTimeout(e=>document.getElementById("find-item").focus(),300)},showWhatsNew(){n.window("whats-new-window")},stop(){if(n.activeItem){let e,t=parseInt(n.audio.dataset.item,10),l=n.audio.dataset.playlist;"number"!=typeof t||isNaN(t)||(e=document.getElementById(l).querySelectorAll(".playlist-item")[t]).classList.remove("bold"),n.audio.pause(),n.lastfm.scrobble(),n.audio.src="",delete n.audio.dataset.item,delete n.audio.dataset.playlist,n.setItemState(),n.updateMeters(),n.setTitle(null,!0),n.setFooter(null,!0),document.getElementById("footer-counter").innerHTML=""}},stopBubbling(e){e.stopPropagation()},toggleMute(){n.pref.muted=!n.audio.muted},translate(){let e=n.pref.lang;return n.langs[e]?(n._translate(),Promise.resolve()):fetch(`/js/i18n/${e}.json?ver=${version}`).then(e=>e.json()).then(t=>(n.langs[e]=t,n._translate(),Promise.resolve()))},updateBatteryStatus(){let e,t,l,a,o=document.getElementById("battery-level-menu-handle"),d=document.querySelectorAll(".battery-level"),s=n.battery.level,r=parseInt(document.getElementById("power-saver-state").value,10)/100;for(let e=0;e<d.length;e++)(a=d[e]).classList.remove("battery-level-green-full"),a.classList.remove("battery-level-green-half"),a.classList.remove("battery-level-orange-full"),a.classList.remove("battery-level-orange-half"),a.classList.remove("battery-level-red-full"),a.classList.remove("battery-level-red-half");n.battery.level<=r&&!n.battery.charging&&n.pref.powerSaverEnabled?n.powerSaveMode||(n.powerSaveMode=!0,n.applyPowerSaveMode()):n.powerSaveMode&&(n.powerSaveMode=!1,n.applyPowerSaveMode()),!n.battery.charging&&n.pref.powerSaverEnabled?(o.setAttribute("title",`${Math.floor(100*n.battery.level)}%`),1>=s&&.83<=s?(e="battery-level-green-full",t="battery-level-green-full",l="battery-level-green-full"):.82>=s&&.66<=s?(e="battery-level-green-full",t="battery-level-green-full",l="battery-level-green-half"):.65>=s&&.5<=s?(e="battery-level-orange-full",t="battery-level-orange-full"):.49>=s&&.33<=s?(e="battery-level-orange-full",t="battery-level-orange-half"):e=.32>=s&&.16<=s?"battery-level-red-full":"battery-level-red-half",e&&document.getElementById("battery-level-1").classList.add(e),t&&document.getElementById("battery-level-2").classList.add(t),l&&document.getElementById("battery-level-3").classList.add(l)):o.removeAttribute("title")},updateCounter(e,t){document.getElementById("footer-counter").innerHTML=`${t.toString().toHHMMSS()}/${e.toString().toHHMMSS()}`},updateFound(){n.console.innerHTML+=`<div class="nb-update"><span class="update">${n.lang.console.update}</span></div>`,document.getElementById("color-bulb").classList.add("nb-update")},updateItemTags(e,t,l=n.activePlaylistId){t=t.tagName?t:document.querySelector(`#${l} .playlist-item[data-url="${t}"]`),Object.assign(t.dataset,e),n.renderItem(t)},updateMeters(){if(n.activeItem){let e=n.audio.duration||1,t=n.audio.currentTime,l=Math.round(100*t/e);if(50<=l&&!n.preloaded){n.preloaded=!0;let e=n.next("next",!0);e&&(e.classList.add("preloaded"),n[e.dataset.cloud].preload(e))}requestAnimationFrame(a=>{n.setProgress(document.getElementById("progress"),l),n.pref.counter&&n.updateCounter(e,t)}),n.audio.paused||setTimeout(n.updateMeters,1e3)}else n.setProgress(document.getElementById("progress"),0)},updateQueueStates(){n.queue.forEach((e,t,n)=>{let l=e.querySelector(".item-queue");t!==n.indexOf(e)||e.querySelector(".playback-status").dataset.icon||(l.innerHTML=t+1)})},updateScrobbleCounter(){document.getElementById("preference-performance-scrobbling-tracks-to-scrobble").innerText=`${n.lastfm.queue.q.size}/${n.lastfm.queue.maxSize}`},updateVolumeState(){n.pref.settings.muted?(n.setProgress(document.getElementById("volume"),0),document.getElementById("trigger-mute").dataset.icon="0"):n.setProgress(document.getElementById("volume"),100*n.pref.settings.volume)},volumeUp(){n.pref.volume=Math.min(1,n.audio.volume+.1)},volumeDown(){n.pref.volume=Math.max(0,n.audio.volume-.1)},get waitingItem(){let e=document.getElementById("playlists").querySelector('div[data-icon="w"]');return e&&(e=e.parentNode.parentNode),e},warn(e,t=""){n.console.innerHTML+=`<div class="nb-warn"><span class="${e}">${n.lang.console[e]}</span>${t}</div>`,document.getElementById("color-bulb").classList.add("nb-warn")},window(e){let t=document.querySelector(".window");switch(e){case"exists":t.classList.remove("exists"),t.classList.add(e);break;default:["add-window","save-playlist-window","load-playlist-window","save-preferences-window","load-preferences-window"].includes(e)&&n.resetAddWindow(),"find-window"===e&&n.emptyFindWindow(),t.id=e,document.getElementById("window-backdrop").classList.add("window-opened")}}};