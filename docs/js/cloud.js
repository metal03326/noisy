"use strict";class Cloud{constructor(e=[]){this.accessToken=null,this.urlManager=urlManager,this.usesIds=!1,Object.assign(this,e)}fetch(e,t="GET",a,n={},o){return fetch(e,{mode:"cors",method:t,body:a||void 0,headers:Object.assign({Authorization:`Bearer ${this.accessToken}`},n)}).then(t=>{if(t.status>=200&&t.status<300)return"arraybuffer"===o?t.arrayBuffer():t.json();{let a=new Error(t.status);throw a.name="FetchError",a.response=t,a.url=e,a}})}get codeName(){return this.name.toLowerCase().replace(/ |\./g,"")}connect(){n.pref.tokenCloud=this.codeName,location.href=this.urls.connect}checkToken(){let e=this.urls.info;return this.fetch(e.url,e.method).then(e=>{let t="",a=this.responseKeys.display_name.split(".");a.forEach((n,o)=>{o+1===a.length?t=e[n]:e=e[n]}),this.display_name=t})}getFolderContents(e,t){if(!t){if(n.emptyAddWindow(),e){let t=this.rootPath;this.usesIds||((t=e.split("/")).pop(),t=t.join("/"));let a={cloud:this.codeName,name:"..",folder:!0,path:t};this.usesIds?(t=n.addItemToWindow(a),asyncLoop(10,a=>this.fetch(this.urls.folder.replace("{{path}}",e)).then(e=>{e.parents.length?t.dataset.path=e.parents[0].id:t.remove()}).catch(e=>{n.log("connection-retry",a.index),n.setFooter(n.lang.console["connection-retry"]+a.index),a.next()})).then(e=>{n.setFooter(null,!0),n.error("cannot-load-url",this.urls.folder)})):n.addItemToWindow(a)}else e=this.rootPath;document.getElementById("add-window-files").dataset.path=e}let a=document.getElementById("add-window-files"),o=a.dataset.filter;a.dataset.cloud=this.codeName;let s,r=this.urls.query;return r.jsonBody&&("/"===e&&(e=""),s=r.jsonBody.replace("{{path}}",e)),this.fetch(r.url.replace("{{path}}",e),r.method,s,r.headers).then(e=>{let a=[],s=[];if(e[this.responseKeys.contents].forEach(e=>{let t={cloud:this.codeName,name:e[this.responseKeys.item],folder:!!~e[this.responseKeys.folder].indexOf("folder"),path:e[this.responseKeys.id?this.responseKeys.id:this.responseKeys.item]};this.usesIds||"/"!==t.name.charAt(0)||(t.name=t.name.substring(1)),t.folder?s.push(t):o&&!~t.name.lastIndexOf(o)||(this.usesIds&&(t.downloadURL=e.downloadUrl),a.push(t))}),t)return Promise.resolve({files:a,folders:s});s.forEach(n.addItemToWindow),a.forEach(n.addItemToWindow),n.applyWindowState("semi"),document.getElementById("loading-folder-contents").classList.add("visibility-hidden")})}loadNoisyFile(e){let t=this.urls.loadPlaylist||{},a={},o=this.usesIds?e.dataset.downloadURL:t.url;return Object.keys(t.headers||{}).forEach(n=>{a[n]=t.headers[n].replace("{{path}}",e.dataset.path)}),new Promise(e=>asyncLoop(10,s=>this.fetch(o,t.method||"GET","",a).then(e).catch(e=>{n.log("connection-retry",s.index),n.setFooter(n.lang.console["connection-retry"]+s.index),s.next()})).then(e=>{n.setFooter(null,!0),n.error("cannot-load-url",o)}))}_preload(e,t){n.setItemState("w",!1,t),asyncLoop(10,a=>{this.fetch(e,"GET",void 0,{},"arraybuffer").then(e=>{let a=t.dataset.placeholder.split(".").pop(),o="unknown";switch(a){case"mp3":o="audio/mpeg";break;case"ogg":case"opus":o="audio/ogg";break;case"m4a":o="audio/mp4";break;case"wav":o="audio/wav"}if(!n.powerSaveMode){const o=t.querySelector(".playback-status").dataset.icon;n.setItemState("w",!1,t,!1),n.readTags(e,a).then(e=>{n.setItemState("w"!==o?o:null,!1,t,!1),n.updateItemTags(e,t)})}o&&!n.formats.includes(o)&&t.classList.add("can-not-play");let s=new Blob([e],{type:o}),r=URL.createObjectURL(s);this.urlManager.add(t.dataset.url,r),document.getElementById(n.audio.dataset.playlist).querySelectorAll(".playlist-item")[n.audio.dataset.item]!==t&&n.setItemState(null,!1,t);let l=document.createElement("audio");l.muted=!0,l.addEventListener("loadedmetadata",e=>{t.dataset.duration=Math.floor(l.duration).toString().toHHMMSS(),l.remove(),n.renderItem(t),n.saveActivePlaylist()}),document.body.appendChild(l),l.src=r,l.load(),document.getElementById(n.audio.dataset.playlist).querySelectorAll(".playlist-item")[parseInt(n.audio.dataset.item,10)]===t&&(n.setTitle(t),n.setFooter(t),n.lastfm.updateNowPlaying(t)),n.audio.paused&&(0===n.audio.currentTime||n.audio.currentTime===n.audio.duration)&&n.audio.dataset.item&&n[t.dataset.cloud].play(t)}).catch(e=>{n.log("connection-retry",a.index),n.setFooter(n.lang.console["connection-retry"]+a.index),a.next()})}).then(t=>{n.setFooter(null,!0),n.error("cannot-load-url",e)})}preload(e){if(!this.urlManager.get(e.dataset.url))if(!this.usesIds&&this.constructor.isValid(e))this._preload(e.dataset.tempurl,e);else{let t,a=this.urls.play;a.jsonBody&&(t=a.jsonBody.replace("{{path}}",e.dataset.url));let o=a.url.replace("{{path}}",e.dataset.url);asyncLoop(10,s=>{this.fetch(o,a.method,t,a.headers).then(t=>{e.dataset.tempurl=this.usesIds?t.downloadUrl:t.link,e.dataset.expires=t.expires?t.expires:new Date(Date.now()+144e5),n.saveActivePlaylist(),this._preload(e.dataset.tempurl,e)}).catch(e=>{n.log("connection-retry",s.index),n.setFooter(n.lang.console["connection-retry"]+s.index),s.next()})}).then(e=>{n.setFooter(null,!0),n.error("cannot-load-url",o)})}}_loadItemFromURL(e,t){n.setItemState("w",!1,t),n.audio.addEventListener("loadedmetadata",function e(){n.audio.removeEventListener("loadedmetadata",e),n.setItemState(null,!1,t);let a=document.getElementById(n.audio.dataset.playlist).querySelectorAll(".playlist-item")[parseInt(n.audio.dataset.item,10)];if(t===a){if(t.dataset.duration=Math.floor(n.audio.duration).toString().toHHMMSS(),"function"==typeof n.audio.mozGetMetadata&&!n.powerSaveMode){let e=n.audio.mozGetMetadata();Object.keys(e).forEach(a=>{t.dataset[a.toLowerCase()]=e[a]})}n.savePlaylist(t.parentNode),n.renderItem(t),n.setTitle(t),n.setFooter(t)}}),n.lastfm.scrobble();let a=t.parentNode.querySelectorAll(".playlist-item");n.audio.dataset.item=Array.prototype.indexOf.call(a,t),n.audio.dataset.playlist=t.parentNode.id,n.audio.src=e,this.preload(t)}play(e){if(e)if(this.urlManager.get(e.dataset.url)){let t=e.closest(".playlist").querySelectorAll(".playlist-item");n.audio.dataset.item=Array.prototype.indexOf.call(t,e),n.audio.dataset.playlist=e.parentNode.id,n.audio.src=this.urlManager.get(e.dataset.url),n.audio.load()}else if(this.constructor.isValid(e))this._loadItemFromURL(e.dataset.tempurl,e);else{let t,a=this.urls.play;a.jsonBody&&(t=a.jsonBody.replace("{{path}}",e.dataset.url));let o=a.url.replace("{{path}}",encodeURIComponent(e.dataset.url));asyncLoop(10,s=>{this.fetch(o,a.method,t,a.headers).then(t=>{e.dataset.tempurl=this.usesIds?t.downloadUrl.replace("&gd=true",""):t.link,e.dataset.expires=t.expires?t.expires:new Date(Date.now()+144e5),n.saveActivePlaylist(),this._loadItemFromURL(e.dataset.tempurl,e)}).catch(e=>{n.log("connection-retry",s.index),n.setFooter(n.lang.console["connection-retry"]+s.index),s.next()})}).then(e=>{n.setFooter(null,!0),n.error("cannot-load-url",o)})}}saveNoisyFile(e,t){let a,o;if(e.endsWith(".plst.nsy")?(a=n.saveActivePlaylist(!0),o="playlist"):(a=n.pref.export(),o="preferences"),a){a.type=o;let s=this.urls.savePlaylist,r={},l=`${t}/${e}`.replace("//","/"),d=s.url.replace("{{path}}",l);Object.keys(s.headers||{}).forEach(e=>{r[e]=s.headers[e].replace("{{path}}",l)}),asyncLoop(10,o=>this.fetch(d,"POST",JSON.stringify(a),r).then(a=>{this.usesIds?(d=this.urls.savePlaylist2.replace("{{path}}",a.id),asyncLoop(10,a=>this.fetch(d,"PUT",`{"title":"${e}","parents":[{"id":"${t}"}]}`,{"Content-Type":"application/json"}).then(e=>{n.log("saved",d),n.setFooter(n.lang.footer["operation-successful"])}).catch(e=>{n.log("connection-retry",a.index),n.setFooter(n.lang.console["connection-retry"]+a.index),a.next()})).then(e=>{n.error("failed-to-save",d),n.setFooter(n.lang.footer["error-see-console"])})):(n.log("saved",d),n.setFooter(n.lang.footer["operation-successful"]))}).catch(e=>{n.log("connection-retry",o.index),n.setFooter(n.lang.console["connection-retry"]+o.index),o.next()})).then(e=>{n.error("failed-to-save",d),n.setFooter(n.lang.footer["error-see-console"])})}}get isAuthenticated(){return!!this.accessToken&&this.accessToken.constructor!==Promise}static isValid(e){return 1===new Date(e.dataset.expires||Date.now())>new Date}}