let lastfm=new Cloud({name:"Last.fm",get apiKey(){return"localhost"===location.hostname?"9d7f26c9783e4e08ee455ec3129830ce":"72e8177b21934e08c11195b8e559c925"},get apiSecret(){return"localhost"===location.hostname?"8f649f54488224c2d056dc40ec3a12d1":"c11941c36875f14d1dfe392848a43685"},urls:{connect:"//www.last.fm/api/auth/?api_key="},queue:{q:new Map,maxSize:50,reset(){this.q.clear(),this.save(),n.updateScrobbleCounter()},add(){if(lastfm.isAuthenticated&&n.pref.scrobbling&&n.audio.dataset.playlist){let e=document.getElementById(n.audio.dataset.playlist).querySelectorAll(".playlist-item")[n.audio.dataset.item];if(e){let t=n.audio.duration,a=Date.now()/1e3-parseInt(n.audio.dataset.start,10);if(a>t&&(a=t),a>=Math.max(30,t*parseInt(n.pref.settings.values["preference-scrobbling-position"],10)/100)){if(this.maxSize<=this.q.size){const[e,t]=this.q.entries().next().value;n.warn("lastfm-queue-overflow",n.formatString(document.getElementById("preference-playlist-format").value,{dataset:{artist:t.artist,title:t.track}})),this.q.delete(e)}let{artist:t,title:a}=e.dataset,s=n.audio.dataset.start;t&&a&&s&&(this.q.has(s)||(this.q.set(s,{artist:t,track:a,timestamp:s}),this.save(),n.updateScrobbleCounter(),this.process()))}}}},process(){if(lastfm.isAuthenticated){let e=[...this.q.keys()],t="",a="",s="track.scrobble",i="",o="",r="",n="";if(e.length){e.map((e,t)=>`[${t}]-${e}`).sort().forEach(e=>{const s=(e=e.split("-"))[0],l=this.q.get(e[1]);t+=`artist${s}${l.artist}`,a+=`&artist${s}=${encodeURIComponent(l.artist)}`,i+=`timestamp${s}${l.timestamp}`,o+=`&timestamp${s}=${l.timestamp}`,r+=`track${s}${l.track}`,n+=`&track${s}=${encodeURIComponent(l.track)}`});let l=`api_key=${lastfm.apiKey}&api_sig=${hex_md5(`api_key${lastfm.apiKey}${t}method${s}sk${lastfm.accessToken}${i}${r}${lastfm.apiSecret}`)}${a}&format=json&method=${s}&sk=${lastfm.accessToken}${o}${n}`;lastfm.fetch(`//ws.audioscrobbler.com/2.0/?${l}`,"POST").then(lastfm.queue.reset.bind(lastfm.queue))}}},save(){localStorage.setItem("lastfm-queue",JSON.stringify([...this.q]))},load(){let e=localStorage.getItem("lastfm-queue");e&&(this.q=new Map(JSON.parse(e)))}},getAccessToken(e){return this.fetch(`//ws.audioscrobbler.com/2.0/?method=auth.getSession&format=json&token=${e}&api_key=${this.apiKey}&api_sig=${hex_md5(`api_key${this.apiKey}methodauth.getSessiontoken${e}${this.apiSecret}`)}`)},checkToken(){return this.fetch(`//ws.audioscrobbler.com/2.0/?method=user.getinfo&format=json&user=${this.userName}&api_key=${this.apiKey}`).then(e=>{let t=e.user.name;if("undefined"===t)throw new Error("No username");this.display_name=t})},updateNowPlaying(e){if(n.pref.scrobbling&&lastfm.isAuthenticated){let{artist:t,title:a}=e.dataset,s="track.updateNowPlaying";if(t&&a){let e=`api_key=${this.apiKey}&api_sig=${hex_md5(`api_key${this.apiKey}artist${t}method${s}sk${this.accessToken}track${a}${this.apiSecret}`)}&artist=${t}&format=json&method=${s}&sk=${this.accessToken}&track=${a}`;this.fetch(`//ws.audioscrobbler.com/2.0/?${e}`,"POST")}}},scrobble(){n.pref.scrobbling&&!n.powerSaveMode&&this.queue.add()}});lastfm.urls.connect+=lastfm.apiKey,lastfm.queue.load();